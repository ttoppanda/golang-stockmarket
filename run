#!/usr/bin/env bash

services=`cat services`

function trade {
  curl -H "Content-Type: application/json" -X POST -d '{bid: 10.10, baseorder: {actor: "Bob", timecreated: 12412132, intent: "BUY", shares: 100, state: "OPEN", ticker: "STOCK", kind: "LIMIT"}}' http://localhost:8001/
  # curl -H "Content-Type: application/json" -X POST -d '{ask: 10.05, baseorder: {actor: "Tim", timecreated: 12412132, intent: "SELL", shares: 100, state: "OPEN", ticker: "STOCK", kind: "LIMIT"}}' http://localhost:8001/
}

# LOCAL
if [[ $1 == "local" ]]; then
  for service in $services; do
    cd $service && go install && cd ..
  done

  mongod &

  for service in $services; do
    $GOPATH/bin/$service &
  done

  # wait for the db to set up after dropping the previous one
  sleep 15
  trade
fi


# INSTALL
if [[ $1 == "install" ]]; then
  for service in $services; do
    cd $service && go install && cd ..
  done
fi


# LIST
if [[ $1 == "list" ]]; then

  ps aux | grep mongod | grep -v grep

  for service in $services; do
    ps aux | grep $service | grep -v grep
  done
fi


# TEST
if [[ $1 == "test" ]]; then
  for service in $services; do
    cd $service && go test && cd ..
  done
fi


# KILL
if [[ $1 == "kill" ]]; then

  pkill -x mongod

  for service in $services; do
    pkill -x $service
  done
fi

