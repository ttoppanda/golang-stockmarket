<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="assets/chart.css" />
        <link rel="stylesheet" href="https://d3fc.io/d3fc.css"/>
    </head>
    <body>
        <div id="streaming-chart" class="chart large"></div>
        <script src="https://d3fc.io/d3fc.bundle.js"></script>
        <script src="assets/data.js"></script>
        <script src="assets/chart.js"></script>
        <script>
            var chart = new Chart({
                data: window._data,
                selector: "#streaming-chart",
                label: "STOCK chart",
                periodMs: 1000 * 60, // * 60 * 24;
                periods: 50
            });

            chart.draw();
            
            if (window.WebSocket){
                socket = new WebSocket("ws://localhost:8004/ws");

                socket.onopen = function(e){
                    var msg = JSON.stringify({
                        user_id: 'userNick',
                        tickers: ['STOCK']
                    });
                    socket.send(msg);
                };

                socket.onmessage = function(e){
                    console.log(e.data);
                    var msg = JSON.parse(e.data);

                    switch (msg.api){
                        case 'ticker':
                        if (!msg.payload.volume){
                            return;
                        }
                        chart.addPartialData(msg.payload);
                        chart.draw();
                        break;
                        default:
                        break;
                    }
                };

                socket.onclose = function(e){
                    console.log("connection closed");
                };
            }
            
            /*
            setInterval(function(){
                if (stream.length !== 0){
                    chart.addData(stream.next());
                    chart.draw();
                }
            }, 1000);
            */
        </script>
    </body>
</html>
